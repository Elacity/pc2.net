# PC2 Node - Docker Compose Configuration
#
# Quick Start:
#   docker-compose up -d
#
# With HTTPS (Let's Encrypt):
#   DOMAIN=your-domain.com LETSENCRYPT_EMAIL=you@email.com docker-compose up -d
#
# View logs:
#   docker-compose logs -f
#
# Stop:
#   docker-compose down

version: '3.8'

services:
  pc2-node:
    build:
      context: ..
      dockerfile: pc2-node/Dockerfile
    image: elastos/pc2-node:latest
    container_name: pc2-node
    restart: unless-stopped
    
    # Port mappings
    ports:
      - "4200:4200"  # Main HTTP/HTTPS
      - "4001:4001"  # IPFS swarm
      - "4002:4002"  # IPFS websocket
    
    # Environment variables
    environment:
      - NODE_ENV=production
      - PORT=4200
      - PC2_DATA_DIR=/app/data
      - PC2_ISOLATION_MODE=namespace
      - HTTPS_ENABLED=${HTTPS_ENABLED:-false}
      - DOMAIN=${DOMAIN:-}
      - LETSENCRYPT_EMAIL=${LETSENCRYPT_EMAIL:-}
    
    # Persistent storage
    volumes:
      - pc2-data:/app/data          # User data, database, IPFS
      - pc2-certs:/app/certs        # SSL certificates
    
    # Security settings for namespace isolation
    security_opt:
      - seccomp:unconfined
    cap_add:
      - SYS_ADMIN
      - NET_ADMIN
    
    # Resource limits (adjust as needed)
    deploy:
      resources:
        limits:
          memory: 2G
        reservations:
          memory: 512M
    
    # Health check
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4200/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Named volumes for persistent data
volumes:
  pc2-data:
    driver: local
  pc2-certs:
    driver: local
