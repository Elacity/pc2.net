<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElastOS - Personal Cloud</title>
    <link rel="stylesheet" href="/bundle.min.css">
    
    <!-- Initialize API origin before SDK loads -->
    <script>
        // CRITICAL: Intercept WebSocket IMMEDIATELY, before ANY other code runs
        (function() {
            const OriginalWebSocket = window.WebSocket;
            window.WebSocket = function(url, protocols) {
                if (typeof url === 'string') {
                    if (url.includes('api.puter.com') || url.includes('puter.com')) {
                        let cleanUrl = url.replace(/:443/g, '');
                        const localOrigin = window.location.origin.replace(/^https?/, 'ws');
                        let localUrl = cleanUrl
                            .replace(/wss?:\/\/api\.puter\.com/g, localOrigin)
                            .replace(/https?:\/\/api\.puter\.com/g, localOrigin)
                            .replace(/wss?:\/\/puter\.com/g, localOrigin)
                            .replace(/https?:\/\/puter\.com/g, localOrigin);
                        url = localUrl;
                    }
                }
                return new OriginalWebSocket(url, protocols);
            };
            Object.setPrototypeOf(window.WebSocket, OriginalWebSocket);
            Object.defineProperty(window.WebSocket, 'prototype', {
                value: OriginalWebSocket.prototype,
                writable: false
            });
            Object.defineProperty(window.WebSocket, 'CONNECTING', { value: OriginalWebSocket.CONNECTING });
            Object.defineProperty(window.WebSocket, 'OPEN', { value: OriginalWebSocket.OPEN });
            Object.defineProperty(window.WebSocket, 'CLOSING', { value: OriginalWebSocket.CLOSING });
            Object.defineProperty(window.WebSocket, 'CLOSED', { value: OriginalWebSocket.CLOSED });
        })();
        
        // Auto-detect API origin from current page URL
        window.api_origin = window.location.origin;
        window.puter_gui_enabled = true;
        
        // Load stored auth token from localStorage
        const storedToken = localStorage.getItem('auth_token');
        if (storedToken) {
            window.auth_token = storedToken;
        }
        
        // Extract auth_token from URL if present
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('auth_token') || urlParams.get('token');
        if (urlToken) {
            window.auth_token = urlToken;
            localStorage.setItem('auth_token', urlToken);
            const newUrl = window.location.pathname + (window.location.hash || '');
            window.history.replaceState({}, '', newUrl);
        }
        
        // Intercept fetch calls to redirect api.puter.com to local server
        const originalFetch = window.fetch;
        window.fetch = function(...args) {
            const url = args[0];
            let options = args[1] || {};
            const token = window.auth_token || localStorage.getItem('auth_token') || null;
            
            if (typeof url === 'string') {
                if (url.includes('api.puter.com') || url.includes('puter.com')) {
                    let cleanUrl = url.replace(/:443/g, '');
                    const localOrigin = window.location.origin;
                    let localUrl = cleanUrl
                        .replace(/https?:\/\/api\.puter\.com/g, localOrigin)
                        .replace(/https?:\/\/puter\.com/g, localOrigin);
                    if (token && (!options.headers || !options.headers['Authorization'])) {
                        options.headers = options.headers || {};
                        if (typeof options.headers === 'object' && !Array.isArray(options.headers)) {
                            options.headers['Authorization'] = 'Bearer ' + token;
                        }
                    }
                    
                    args[0] = localUrl;
                    args[1] = options;
                }
            }
            return originalFetch.apply(this, args);
        };
        
        // Intercept XMLHttpRequest to redirect and inject auth token
        const originalXHROpen = XMLHttpRequest.prototype.open;
        const originalXHRSetRequestHeader = XMLHttpRequest.prototype.setRequestHeader;
        
        XMLHttpRequest.prototype.open = function(method, url, ...rest) {
            this._url = url;
            this._originalMethod = method;
            
            if (typeof url === 'string') {
                if (url.includes('api.puter.com') || url.includes('puter.com')) {
                    let cleanUrl = url.replace(/:443/g, '');
                    const localOrigin = window.location.origin;
                    let localUrl = cleanUrl
                        .replace(/https?:\/\/api\.puter\.com/g, localOrigin)
                        .replace(/https?:\/\/puter\.com/g, localOrigin);
                    url = localUrl;
                    this._interceptedUrl = localUrl;
                    this._url = localUrl;
                }
            }
            return originalXHROpen.call(this, method, url, ...rest);
        };
        
        XMLHttpRequest.prototype.setRequestHeader = function(header, value) {
            const token = window.auth_token || localStorage.getItem('auth_token') || null;
            if (this._interceptedUrl && header.toLowerCase() !== 'authorization') {
                if (token) {
                    originalXHRSetRequestHeader.call(this, 'Authorization', 'Bearer ' + token);
                }
            }
            return originalXHRSetRequestHeader.call(this, header, value);
        };
        
        const originalXHRSend = XMLHttpRequest.prototype.send;
        XMLHttpRequest.prototype.send = function(data) {
            const xhr = this;
            const originalOnReadyStateChange = xhr.onreadystatechange;
            const token = window.auth_token || localStorage.getItem('auth_token') || null;
            const url = this._interceptedUrl || this._url || '';
            const isLocalAPIRequest = url.includes('localhost:4202') || 
                                     url.includes(window.location.origin) ||
                                     (url.startsWith('/') && !url.startsWith('//'));
            
            if (isLocalAPIRequest && !url.includes('socket.io') && !url.includes('particle-auth')) {
                if (token) {
                    try {
                        originalXHRSetRequestHeader.call(this, 'Authorization', 'Bearer ' + token);
                    } catch (e) {
                        // Silently fail
                    }
                }
            }
            
            xhr.onreadystatechange = function() {
                if (xhr.readyState === 4 && xhr.status === 200) {
                    try {
                        const responseText = xhr.responseText;
                        if (responseText) {
                            const response = JSON.parse(responseText);
                            if (response.token || response.auth_token) {
                                const token = response.token || response.auth_token;
                                if (token.length === 64 && /^[0-9a-f]+$/i.test(token)) {
                                    window.auth_token = token;
                                    localStorage.setItem('auth_token', token);
                                }
                            }
                        }
                    } catch (e) {
                        // Not JSON or parsing failed, ignore
                    }
                }
                if (originalOnReadyStateChange) {
                    originalOnReadyStateChange.call(this);
                }
            };
            
            return originalXHRSend.call(this, data);
        };
        
        window.puter_api_origin = window.location.origin;
        
        // Initialize service_script_api_promise
        let serviceScriptResolve, serviceScriptReject;
        const serviceScriptPromise = new Promise((resolve, reject) => {
            serviceScriptResolve = resolve;
            serviceScriptReject = reject;
        });
        const serviceScriptAPI = {
            then: serviceScriptPromise.then.bind(serviceScriptPromise),
            catch: serviceScriptPromise.catch.bind(serviceScriptPromise),
            finally: serviceScriptPromise.finally.bind(serviceScriptPromise),
            resolve: serviceScriptResolve,
            reject: serviceScriptReject
        };
        window.service_script_api_promise = serviceScriptAPI;
        globalThis.service_script_api_promise = serviceScriptAPI;
        
        window.service_script = async function(fn) {
            try {
                await fn(await window.service_script_api_promise);
            } catch (e) {
                console.error('service_script(ERROR)', e);
            }
        };
    </script>
</head>
<body>
    <div id="app"></div>
    <script src="/bundle.min.js"></script>
    <script src="/gui.js"></script>
    
    <!-- Initialize GUI -->
    <script type="text/javascript">
        // CRITICAL: Guard against multiple initializations
        // IMPORTANT: Don't reset flags if already set (prevents re-init on script re-execution)
        if (typeof window._gui_init_started === 'undefined') {
            window._gui_init_started = false;
        }
        if (typeof window._gui_init_completed === 'undefined') {
            window._gui_init_completed = false;
        }
        
        // Only define initializeGUI once
        if (!window._initializeGUI_defined) {
            window._initializeGUI_defined = true;
            
            window.initializeGUI = function() {
                // Guard: Only initialize once
                if (window._gui_init_started || window._gui_init_completed) {
                    return;
                }
                window._gui_init_started = true;
                
                if (typeof gui === 'function' || typeof window.gui === 'function') {
                    const guiFunc = gui || window.gui;
                    guiFunc({
                        gui_origin: window.location.origin,
                        api_origin: undefined,
                        title: 'ElastOS',
                        max_item_name_length: 150,
                        require_email_verification_to_publish_website: false,
                        short_description: 'ElastOS is a privacy-first personal cloud.',
                    }).then(() => {
                        window._gui_init_completed = true;
                    }).catch((e) => {
                        console.error('[PC2]: GUI init failed:', e);
                        // Only allow retry if we haven't completed initialization
                        if (!window._gui_init_completed) {
                            window._gui_init_started = false;
                        }
                    });
                } else {
                    window._gui_init_started = false; // Allow retry
                    setTimeout(window.initializeGUI, 500);
                }
            };
            
            // Only add event listener once
            window.addEventListener('load', function() {
                if (!window._gui_init_started && !window._gui_init_completed) {
                    setTimeout(window.initializeGUI, 100);
                }
            });
        }
        
        // Initial trigger (but guard against re-execution)
        if (document.readyState === 'complete' || document.readyState === 'interactive') {
            if (!window._gui_init_started && !window._gui_init_completed) {
                setTimeout(window.initializeGUI, 100);
            }
        }
    </script>
</body>
</html>