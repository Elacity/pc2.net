<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WASM Calculator</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #818cf8 0%, #667eea 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .calculator {
            background: #1e1e2e;
            border-radius: 20px;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.4);
            padding: 24px;
            width: 320px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .title {
            color: #cdd6f4;
            font-size: 14px;
            font-weight: 500;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: #6c7086;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            line-height: 1;
        }
        
        .close-btn:hover {
            color: #f38ba8;
        }
        
        .display {
            background: #313244;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            text-align: right;
        }
        
        .expression {
            color: #6c7086;
            font-size: 14px;
            height: 20px;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .result {
            color: #cdd6f4;
            font-size: 36px;
            font-weight: 300;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }
        
        .btn {
            background: #45475a;
            border: none;
            border-radius: 12px;
            color: #cdd6f4;
            font-size: 20px;
            font-weight: 500;
            padding: 18px;
            cursor: pointer;
            transition: background 0.15s, transform 0.1s;
        }
        
        .btn:hover {
            background: #585b70;
        }
        
        .btn:active {
            transform: scale(0.95);
        }
        
        .btn.operator {
            background: #f9a825;
            color: #1e1e2e;
        }
        
        .btn.operator:hover {
            background: #ffb300;
        }
        
        .btn.function {
            background: #6c7086;
            color: #1e1e2e;
        }
        
        .btn.function:hover {
            background: #7f849c;
        }
        
        .btn.equals {
            background: #a6e3a1;
            color: #1e1e2e;
        }
        
        .btn.equals:hover {
            background: #b4e8b0;
        }
        
        .btn.zero {
            grid-column: span 2;
        }
        
        .powered-by {
            text-align: center;
            margin-top: 16px;
            font-size: 11px;
            color: #6c7086;
        }
        
        .powered-by span {
            color: #cba6f7;
        }
    </style>
</head>
<body>
    <div class="calculator">
        <div class="header">
            <span class="title">WASM Calculator</span>
            <button class="close-btn" id="closeBtn" title="Close">&times;</button>
        </div>
        
        <div class="display">
            <div class="expression" id="expression"></div>
            <div class="result" id="result">0</div>
        </div>
        
        <div class="buttons">
            <button class="btn function" data-action="clear">C</button>
            <button class="btn function" data-action="toggle-sign">+/-</button>
            <button class="btn function" data-action="percent">%</button>
            <button class="btn operator" data-action="divide">&divide;</button>
            
            <button class="btn" data-digit="7">7</button>
            <button class="btn" data-digit="8">8</button>
            <button class="btn" data-digit="9">9</button>
            <button class="btn operator" data-action="multiply">&times;</button>
            
            <button class="btn" data-digit="4">4</button>
            <button class="btn" data-digit="5">5</button>
            <button class="btn" data-digit="6">6</button>
            <button class="btn operator" data-action="subtract">&minus;</button>
            
            <button class="btn" data-digit="1">1</button>
            <button class="btn" data-digit="2">2</button>
            <button class="btn" data-digit="3">3</button>
            <button class="btn operator" data-action="add">+</button>
            
            <button class="btn zero" data-digit="0">0</button>
            <button class="btn" data-action="decimal">.</button>
            <button class="btn equals" data-action="equals">=</button>
        </div>
        
        <div class="powered-by">
            Powered by <span>PC2 WASM Runtime</span>
        </div>
    </div>
    
    <script>
        // Calculator state
        let currentValue = '0';
        let previousValue = '';
        let operator = '';
        let shouldResetDisplay = false;
        
        // Get appInstanceID from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const appInstanceID = urlParams.get('puter.app_instance_id') || 
                              urlParams.get('puter.appInstanceID') || 
                              urlParams.get('appInstanceID');
        
        // Send READY message to parent
        if (appInstanceID) {
            window.parent.postMessage({
                msg: 'READY',
                appInstanceID: appInstanceID,
                env: 'app'
            }, '*');
        }
        
        // Close button
        document.getElementById('closeBtn').addEventListener('click', () => {
            window.parent.postMessage({
                msg: 'exit',
                appInstanceID: appInstanceID,
                statusCode: 0
            }, '*');
        });
        
        // Handle windowWillClose from parent - MUST respond for window to close
        window.addEventListener('message', (event) => {
            if (event.data.msg === 'windowWillClose') {
                console.log('[Calculator] Received windowWillClose, responding...');
                window.parent.postMessage({
                    msg: 'windowWillCloseAck',
                    original_msg_id: event.data.msg_id
                }, '*');
            }
        });
        
        // DOM elements
        const expressionEl = document.getElementById('expression');
        const resultEl = document.getElementById('result');
        
        // Format number for display
        function formatNumber(num) {
            const str = num.toString();
            if (str.length > 12) {
                const n = parseFloat(num);
                if (Math.abs(n) >= 1e12 || (Math.abs(n) < 1e-6 && n !== 0)) {
                    return n.toExponential(6);
                }
                return n.toPrecision(10);
            }
            return str;
        }
        
        // Update display
        function updateDisplay() {
            resultEl.textContent = formatNumber(currentValue);
            
            if (previousValue && operator) {
                const ops = { 'add': '+', 'subtract': '−', 'multiply': '×', 'divide': '÷' };
                expressionEl.textContent = `${formatNumber(previousValue)} ${ops[operator]}`;
            } else {
                expressionEl.textContent = '';
            }
        }
        
        // Calculate result
        function calculate(a, b, op) {
            const numA = parseFloat(a);
            const numB = parseFloat(b);
            
            switch (op) {
                case 'add': return numA + numB;
                case 'subtract': return numA - numB;
                case 'multiply': return numA * numB;
                case 'divide': return numB !== 0 ? numA / numB : 'Error';
                default: return numB;
            }
        }
        
        // Handle digit input
        function inputDigit(digit) {
            if (shouldResetDisplay) {
                currentValue = digit;
                shouldResetDisplay = false;
            } else {
                currentValue = currentValue === '0' ? digit : currentValue + digit;
            }
            updateDisplay();
        }
        
        // Handle decimal
        function inputDecimal() {
            if (shouldResetDisplay) {
                currentValue = '0.';
                shouldResetDisplay = false;
            } else if (!currentValue.includes('.')) {
                currentValue += '.';
            }
            updateDisplay();
        }
        
        // Handle operator
        function handleOperator(op) {
            if (previousValue && operator && !shouldResetDisplay) {
                const result = calculate(previousValue, currentValue, operator);
                currentValue = result.toString();
                previousValue = currentValue;
            } else {
                previousValue = currentValue;
            }
            operator = op;
            shouldResetDisplay = true;
            updateDisplay();
        }
        
        // Handle equals
        function handleEquals() {
            if (previousValue && operator) {
                const result = calculate(previousValue, currentValue, operator);
                currentValue = result.toString();
                previousValue = '';
                operator = '';
                shouldResetDisplay = true;
                updateDisplay();
            }
        }
        
        // Handle clear
        function handleClear() {
            currentValue = '0';
            previousValue = '';
            operator = '';
            shouldResetDisplay = false;
            updateDisplay();
        }
        
        // Handle toggle sign
        function handleToggleSign() {
            currentValue = (parseFloat(currentValue) * -1).toString();
            updateDisplay();
        }
        
        // Handle percent
        function handlePercent() {
            currentValue = (parseFloat(currentValue) / 100).toString();
            updateDisplay();
        }
        
        // Button click handlers
        document.querySelectorAll('.btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const digit = btn.dataset.digit;
                const action = btn.dataset.action;
                
                if (digit !== undefined) {
                    inputDigit(digit);
                } else if (action) {
                    switch (action) {
                        case 'clear': handleClear(); break;
                        case 'toggle-sign': handleToggleSign(); break;
                        case 'percent': handlePercent(); break;
                        case 'decimal': inputDecimal(); break;
                        case 'equals': handleEquals(); break;
                        case 'add':
                        case 'subtract':
                        case 'multiply':
                        case 'divide':
                            handleOperator(action);
                            break;
                    }
                }
            });
        });
        
        // Keyboard support
        document.addEventListener('keydown', (e) => {
            if (e.key >= '0' && e.key <= '9') inputDigit(e.key);
            else if (e.key === '.') inputDecimal();
            else if (e.key === '+') handleOperator('add');
            else if (e.key === '-') handleOperator('subtract');
            else if (e.key === '*') handleOperator('multiply');
            else if (e.key === '/') handleOperator('divide');
            else if (e.key === 'Enter' || e.key === '=') handleEquals();
            else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') handleClear();
            else if (e.key === '%') handlePercent();
        });
        
        // Initial display
        updateDisplay();
    </script>
</body>
</html>
