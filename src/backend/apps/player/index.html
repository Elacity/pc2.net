<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="description" content="" />
    <meta charset="utf-8">
    <title>Player</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="author" content="">
    <!-- CSS -->
    <!-- <link rel="stylesheet" href="css/normalize.css"> -->
    <!-- Preload images -->
    <!-- <link rel="preload" as="image" href="./img/arrow-left.svg"> -->
    <style>
        #player{
            width: 100%;
            height: 100%;
            background-color: black;
        }
    </style>
</head>

<body style="padding:0; margin: 0; height:calc(100vh); background-size: contain; width:100%; background-position: center; background-repeat: no-repeat;">
    <video id="player" width="320" height="240" controls autoplay preload="auto" crossorigin="anonymous" playsinline></video>
    <!-- JS -->
    <script>
        // CRITICAL: Intercept API calls BEFORE SDK loads to redirect to PC2 node
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiOrigin = urlParams.get('puter.api_origin') || window.location.origin;
            
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                let url = args[0];
                if (typeof url === 'string' && url.includes('api.puter.')) {
                    args[0] = url.replace(/https?:\/\/api\.puter\.[^\/:]+(?::\d+)?/gi, apiOrigin);
                } else if (url && typeof url === 'object' && url.url && url.url.includes('api.puter.')) {
                    url.url = url.url.replace(/https?:\/\/api\.puter\.[^\/:]+(?::\d+)?/gi, apiOrigin);
                }
                return originalFetch.apply(this, args);
            };
            
            const originalXHROpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url, ...rest) {
                if (typeof url === 'string' && url.includes('api.puter.')) {
                    url = url.replace(/https?:\/\/api\.puter\.[^\/:]+(?::\d+)?/gi, apiOrigin);
                }
                return originalXHROpen.call(this, method, url, ...rest);
            };
        })();
    </script>
    <script src="./js/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="./js/puter-sdk/puter-sdk-v2.js"></script>
    <script>
        // Initialize Puter SDK with auth token and API origin from URL params
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const authToken = urlParams.get('puter.auth.token');
            const apiOrigin = urlParams.get('puter.api_origin');
            
            function initializeSDK() {
                if (typeof puter === 'undefined') {
                    setTimeout(initializeSDK, 10);
                    return;
                }
                
                if (authToken) {
                    try {
                        puter.setAuthToken(authToken);
                        console.log('[Player]: ‚úÖ Auth token set from URL params');
                    } catch (e) {
                        console.error('[Player]: Failed to set auth token:', e);
                    }
                }
                
                if (apiOrigin) {
                    try {
                        puter.setAPIOrigin(apiOrigin);
                        console.log('[Player]: ‚úÖ API origin set to:', apiOrigin);
                    } catch (e) {
                        console.error('[Player]: Failed to set API origin:', e);
                    }
                }
            }
            
            initializeSDK();
        })();
    </script>
    <script src="./js/html-entities.js"></script>
    <script>
    let curfile;

    puter.ui.onItemsOpened (async (items)=>{
        if(items.length > 0){
            curfile = items[0];
            puter.ui.setWindowTitle(curfile.name);
            open_file(curfile)
        }
    })

    async function open_file(cfile){
        curfile = cfile;
        //update player - set source correctly for seeking to work
        const video = $("#player").get(0);
        
        // Pause and reset video first
        video.pause();
        video.currentTime = 0;
        
        // Clear existing sources - use direct src assignment for better seeking support
        video.innerHTML = '';
        
        // Set source directly on video element (better for seeking than <source> element)
        const videoUrl = html_encode(curfile.readURL);
        video.src = videoUrl;
        
        // Try to detect MIME type from file extension for type hint
        const ext = curfile.name.split('.').pop().toLowerCase();
        const mimeTypes = {
            'mp4': 'video/mp4',
            'webm': 'video/webm',
            'ogg': 'video/ogg',
            'mov': 'video/quicktime',
            'avi': 'video/x-msvideo',
            'mkv': 'video/x-matroska'
        };
        if (mimeTypes[ext]) {
            video.type = mimeTypes[ext];
        }
        
        // change window title
        puter.ui.setWindowTitle(curfile.name);
        
        // Load video - this will enable seeking once metadata is loaded
        video.load();
        
        // Wait for metadata to load before playing (enables seeking)
        const playWhenReady = function() {
            if (video.readyState >= 1) { // HAVE_METADATA
                video.play().catch(err => {
                    console.log('[Player]: Autoplay blocked, user interaction required:', err);
                });
            } else {
                setTimeout(playWhenReady, 100);
            }
        };
        
        video.addEventListener('loadedmetadata', function() {
            console.log('[Player]: Video metadata loaded, duration:', video.duration);
            console.log('[Player]: Seekable ranges:', video.seekable.length);
            if (video.seekable.length > 0) {
                console.log('[Player]: Seekable from', video.seekable.start(0), 'to', video.seekable.end(0));
            }
            playWhenReady();
        }, { once: true });
        
        // Also handle canplay event for better compatibility
        video.addEventListener('canplay', function() {
            console.log('[Player]: Video can play, seeking should work now');
        }, { once: true });
        
        // Enable seeking explicitly - log when seeking happens
        video.addEventListener('seeking', function() {
            console.log('[Player]: üîç Seeking to:', video.currentTime, 'seconds');
        });
        
        video.addEventListener('seeked', function() {
            console.log('[Player]: ‚úÖ Seeked to:', video.currentTime, 'seconds');
        });
        
        // Log any errors
        video.addEventListener('error', function(e) {
            console.error('[Player]: Video error:', e, 'code:', video.error?.code, 'message:', video.error?.message);
        });
    }

    $('#player').on('dragover', function(e) {
        e.preventDefault();
        e.stopPropagation();
    })
    $('#player').on('dragenter', function (e) {
        e.preventDefault();
        e.stopPropagation();
    })

    $('#player').on('drop', async function (e) {
        if (e.originalEvent.dataTransfer && e.originalEvent.dataTransfer.files.length) {
            e.preventDefault();
            e.stopPropagation();
            let URL = window.URL || window.webkitURL
            let file = e.originalEvent.dataTransfer.files[0];
            // set file name 
            default_file_name = file.name;
            // change window title
            puter.ui.setWindowTitle(file.name)
            // curfile is dead
            curfile = undefined;
            // read content - set source directly for better seeking support
            const video = $("#player").get(0);
            // Pause and reset first
            video.pause();
            video.currentTime = 0;
            // Clear existing sources
            video.innerHTML = '';
            // Set source directly on video element
            video.src = URL.createObjectURL(file);
            video.type = file.type || 'video/mp4';
            // restart video - this ensures seeking is enabled
            video.load();
            // Wait for metadata to load before playing (enables seeking)
            video.addEventListener('loadedmetadata', function() {
                console.log('[Player]: Drag-drop video loaded, duration:', video.duration);
                video.play();
            }, { once: true });
        }
    });
    </script>
</body>

</html>