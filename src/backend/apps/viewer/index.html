<!DOCTYPE html>
<html lang="en">

<head>
    <meta name="description" content="" />
    <meta charset="utf-8">
    <title>Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="">
    <!-- CSS -->
    <link rel="stylesheet" href="css/normalize.css">
    <link rel="stylesheet" href="jquery-pintura/pintura.min.css">
    <link rel="stylesheet" href="css/style.css">
    <!-- Preload images -->
    <link rel="preload" as="image" href="./img/magnifier-zoom-in.svg">
    <link rel="preload" as="image" href="./img/magnifier-zoom-out.svg">
</head>

<body style="padding:0; margin: 0; height:calc(100vh); width:100%;">
    <button id="save-btn" disabled>Save</button>
    <div class="my-editor" style="height:calc(100vh); width:100%;">
    </div>
    <!-- JS -->
    <script>
        // CRITICAL: Intercept API calls BEFORE SDK loads to redirect to PC2 node
        // This must run FIRST, before any other scripts
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const apiOrigin = urlParams.get('puter.api_origin') || window.location.origin;
            const currentOrigin = window.location.origin;
            
            console.log('[Viewer]: üîß Setting up API interception, API origin:', apiOrigin);
            
            // Intercept fetch requests - redirect api.puter.* to PC2 node
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                let url = args[0];
                if (typeof url === 'string') {
                    if (url.includes('api.puter.')) {
                        const interceptedUrl = url.replace(/https?:\/\/api\.puter\.[^\/:]+(?::\d+)?/gi, apiOrigin);
                        console.log('[Viewer]: üîÑ Intercepting fetch:', url, '->', interceptedUrl);
                        args[0] = interceptedUrl;
                    }
                } else if (url && typeof url === 'object' && url.url) {
                    if (url.url.includes('api.puter.')) {
                        url.url = url.url.replace(/https?:\/\/api\.puter\.[^\/:]+(?::\d+)?/gi, apiOrigin);
                        console.log('[Viewer]: üîÑ Intercepting fetch (Request object):', url.url);
                    }
                }
                return originalFetch.apply(this, args);
            };
            
            // Intercept XMLHttpRequest
            const originalXHROpen = XMLHttpRequest.prototype.open;
            XMLHttpRequest.prototype.open = function(method, url, ...rest) {
                if (typeof url === 'string' && url.includes('api.puter.')) {
                    const interceptedUrl = url.replace(/https?:\/\/api\.puter\.[^\/:]+(?::\d+)?/gi, apiOrigin);
                    console.log('[Viewer]: üîÑ Intercepting XHR:', url, '->', interceptedUrl);
                    url = interceptedUrl;
                }
                return originalXHROpen.call(this, method, url, ...rest);
            };
            
            console.log('[Viewer]: ‚úÖ API interception active');
        })();
    </script>
    <script src="./js/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://js.puter.com/v2/"></script>
    <script>
        // Initialize Puter SDK with auth token and API origin from URL params
        // This prevents the SDK from showing login screen when app is opened
        // Must run immediately after SDK loads, before any auth checks
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            const authToken = urlParams.get('puter.auth.token');
            const apiOrigin = urlParams.get('puter.api_origin');
            
            console.log('[Viewer]: üìã URL params - authToken:', authToken ? 'present' : 'missing', 'apiOrigin:', apiOrigin);
            
            // Wait for SDK to be available, then set auth immediately
            function initializeSDK() {
                if (typeof puter === 'undefined') {
                    // SDK not loaded yet, wait a bit and try again
                    setTimeout(initializeSDK, 10);
                    return;
                }
                
                console.log('[Viewer]: ‚úÖ SDK loaded, setting auth...');
                
                // SDK is loaded, set auth token and API origin immediately
                if (authToken) {
                    try {
                        puter.setAuthToken(authToken);
                        console.log('[Viewer]: ‚úÖ Auth token set from URL params');
                    } catch (e) {
                        console.error('[Viewer]: ‚ùå Failed to set auth token:', e);
                    }
                } else {
                    console.warn('[Viewer]: ‚ö†Ô∏è No auth token in URL params!');
                }
                
                if (apiOrigin) {
                    try {
                        puter.setAPIOrigin(apiOrigin);
                        console.log('[Viewer]: ‚úÖ API origin set to:', apiOrigin);
                    } catch (e) {
                        console.error('[Viewer]: ‚ùå Failed to set API origin:', e);
                    }
                } else {
                    console.warn('[Viewer]: ‚ö†Ô∏è No API origin in URL params!');
                }
            }
            
            // Start initialization immediately
            initializeSDK();
        })();
    </script>
    <script src="./jquery-pintura/pintura.min.js"></script>
    <script src="./jquery-pintura/useEditorWithJQuery-iife.js"></script>
    <script src="./js/Viewer.js"></script>
</body>